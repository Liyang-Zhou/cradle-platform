stages:
  - build
  - test
  - format
  - deploy

variables:
  STAGING_BRANCH: "master"
  PROD_BRANCH: "task/CRDL-156-DockerCleanup"

frontend build:
  stage: build
  image: node:10
  tags:
    - docker
  rules:
    # run for testing for merge requests
    - if: '$CI_MERGE_REQUEST_ID != null'
      changes:
        - client/**/*
      when: on_success
    # run automatically for deploying to staging
    - if: '$CI_COMMIT_BRANCH == $STAGING_BRANCH'
      when: on_success
    # run manually for deploying to production
    - if: '$CI_COMMIT_BRANCH == $PROD_BRANCH'
      when: manual
  before_script:
    - cd client
    - npm install
  script:
    - CI=false npm run build
  after_script:
    - tar -czvf frontend.tar.gz client/build
  artifacts:
    paths:
      - frontend.tar.gz

backend unit tests:
  stage: test
  image: python:3.7.6-buster
  tags:
    - docker
  rules:
    - if: '$CI_MERGE_REQUEST_ID != null || $CI_COMMIT_BRANCH == $STAGING_BRANCH'
    - changes:
      - server/**/*
  before_script:
    - cd server
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python -m pytest tests

backend system tests:
  stage: test
  image: python:3.7.6-buster
  tags:
    - docker
  rules:
    - if: '$CI_MERGE_REQUEST_ID != null || $CI_COMMIT_BRANCH == $STAGING_BRANCH'
    - changes:
      - server/**/*
  variables:
    DB_USERNAME: "root"
    DB_PASSWORD: "ci-password"
    EMAIL_USER: "ci@ci.com"
    EMAIL_PASSWORD: "ci-password"
    DB_HOSTNAME: "mysql"
    DB_PORT: "3306"
    DB_NAME: "cradle"
    PORT: "5000"
    MYSQL_DATABASE: "cradle"
    MYSQL_ROOT_PASSWORD: "ci-password"
  services:
    - mysql:5.7
  before_script:
    - apt-get update -y
    - apt-get install default-mysql-client -y
    - cd server
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - python3 app.py &
    - python3 db.py rebuild --no-docker
    - python3 manage.py seed_test_data
  script:
    - python -m pytest systemTests

frontend lint:
  stage: format
  image: node:10
  tags:
    - docker
  rules:
    - if: '$CI_MERGE_REQUEST_ID != null || $CI_COMMIT_BRANCH == $STAGING_BRANCH'
      when: always
    - changes:
      - client/**/*
      when: always
  before_script:
    - cd client
    - npm install
  script:
    - ./node_modules/.bin/eslint "src/**/*.{ts,tsx}"

frontend format:
  stage: format
  image: node:10
  tags:
    - docker
  rules:
    - if: '$CI_MERGE_REQUEST_ID != null || $CI_COMMIT_BRANCH == $STAGING_BRANCH'
      when: always
    - changes:
      - client/**/*
      when: always
  before_script:
    - npm install prettier --global
  script:
    - prettier --check "client/src/**/*.{ts,tsx}"

backend format:
  stage: format
  image: python:3.7.6-buster
  tags:
    - docker
  rules:
    - if: '$CI_MERGE_REQUEST_ID != null || $CI_COMMIT_BRANCH == $STAGING_BRANCH'
      when: always
    - changes:
      - server/**/*
      when: always
  before_script:
    - pip install --upgrade pip
    - pip install black
  script:
    - black --check --exclude 'server/migrations/.*' server

deploy staging:
  stage: deploy
  dependencies:
    - frontend build
  tags:
    - shell
  rules:
    - if: '$CI_MERGE_REQUEST_ID == null && $CI_COMMIT_BRANCH == $STAGING_BRANCH'
      when: on_success
    - when: never
  script:
    - cp /var/cradle/.env ./.env
    - tar -xvf frontend.tar.gz
    - docker-compose -f docker-compose.yml -f docker-compose.prod.yml up --force-recreate -d
    # wait for MySQL to start (up to 60 seconds) and then upgrade the database schema
    - docker exec flask timeout 60 bash -c "while ! bash -c 'echo > /dev/tcp/mysql/3306'; do sleep 1; done;" &>-
    - docker exec flask flask db upgrade

deploy prod:
  stage: deploy
  dependencies:
    - frontend build
  tags:
    - shell-prod
  rules:
    - if: '$CI_MERGE_REQUEST_ID == null && $CI_COMMIT_BRANCH == $PROD_BRANCH'
      when: manual
    - when: never
  script:
    - cp /var/cradle/.env ./.env
    - tar -xvf frontend.tar.gz
    - docker-compose -f docker-compose.yml -f docker-compose.prod.yml up --force-recreate -d
    # wait for MySQL to start (up to 60 seconds) and then upgrade the database schema
    - docker exec flask timeout 60 bash -c "while ! bash -c 'echo > /dev/tcp/mysql/3306'; do sleep 1; done;" &>-
    - docker exec flask flask db upgrade