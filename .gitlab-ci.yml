stages:
    - build
    - test
    - deploy

build:
    stage: build
    before_script:
        - cd /var/www/cradle-platform
        - pwd
        - whoami
        - git checkout $CI_COMMIT_BRANCH
        - git branch
        - git fetch
        - git reset --hard origin/$CI_COMMIT_BRANCH
    script:
        - echo "Building project..."
        - docker-compose -f docker-compose.prod.yml up --build --no-start
    rules:
        - if: $CI_COMMIT_BRANCH == "production"
        - if: $CI_COMMIT_BRANCH == "staging"
        - allow_failure: false

test:
    stage: test
    script:
        - echo "Running tests..."
    rules:
        - if: $CI_COMMIT_BRANCH == "production"
        - if: $CI_COMMIT_BRANCH == "staging"
        - allow_failure: false

deploy:
    stage: deploy
    script: 
        - echo "Deploying project..."
        - docker-compose -f docker-compose.prod.yml up -d
    only: 
        - production
    when: manual
    allow_failure: false
    environment: production
